var NS=window.NS||{};
NS.MediaWikiApiClient=function(){var h={"image/jpeg":".jpg","image/png":".png"},g=function(e){this.basePath=e;this.isLogged=!1};g.prototype.logout=function(){return $.post(this.basePath+"?action=logout&format=json")};g.prototype.login=function(e,f){var c=this,a=$.Deferred(),b=this.basePath+"?action=login&lgname="+e+"&lgpassword="+f+"&format=json";$.post(b,function(d){"NeedToken"==d.login.result?$.post(b+"&lgtoken="+d.login.token,function(b){b.error?a.reject({status:6,msg:b.error}):"Success"==b.login.result?
(c.username=e,c.isLogged=!0,a.resolve()):a.reject({status:3,msg:b.login.result})}):a.reject({status:6,msg:d.error})});return a.promise()};g.prototype.getUniqueFileName=function(e,f,c,a){c=c||0;a=a||"File:";var b=$.Deferred(),d=a+e+(0==c?"":"_"+c)+(f in h?h[f]:""),k=this;this.getEditToken(d,!1).then(function(a){b.resolve(d)},function(a){3==a.status?k.getUniqueFileName(e,f,c+1).then(function(a){b.resolve(a)},function(a){b.reject(a)}):b.reject(a)});return b.promise()};g.prototype.getEditToken=function(e,
f){var c=$.Deferred();$.get(this.basePath+"?action=query&prop=info&intoken=edit&titles="+e+"&format=json",function(a){a.query.pages?"-1"in a.query.pages||!1!=f?$.each(a.query.pages,function(a,d){c.resolve(d.edittoken)}):c.reject({status:3,msg:"Page already exist !"}):c.reject({status:6,msg:a})});return c.promise()};g.prototype.doApiCallUpload=function(e,f,c,a){var b=$.Deferred(),d=new FormData;d.append("file",f);d.append("text",a);$.ajax({type:"POST",url:this.basePath+"?action=upload&format=json&filename="+
encodeURIComponent(c)+"&ignorewarnings=1&token="+encodeURIComponent(e),contentType:!1,processData:!1,data:d,success:function(a){a.upload?b.resolve(a):b.reject({status:3,msg:a.error.info})},error:function(a,c,d){b.reject({status:c,msg:d})}});return b.promise()};g.prototype.uploadFile=function(e,f,c,a){var b=$.Deferred(),d=this;this.getEditToken(f,c).then(function(c){d.doApiCallUpload(c,e,f,a).done(function(a){b.resolve(a)}).fail(function(a){b.reject(a)})},function(a){b.reject(a)});return b.promise()};
return g}();
